FROM openjdk:17-jdk-slim

# Install curl for health checks
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy Maven wrapper and pom.xml first for better caching
COPY pom.xml ./
COPY .mvn .mvn
COPY mvnw ./

# Make Maven wrapper executable
RUN chmod +x ./mvnw

# Download dependencies
RUN ./mvnw dependency:go-offline -B

# Copy source code
COPY src ./src

# Set JVM arguments for development
ENV JVM_OPTS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 -Xmx512m -Xms256m"

# Expose ports
EXPOSE 4000 5005

# Create a script to run the application with hot reload
RUN echo '#!/bin/bash\n\
./mvnw spring-boot:run \
  -Dspring-boot.run.jvmArguments="$JVM_OPTS" \
  -Dspring-boot.run.fork=false \
  -Dspring.devtools.restart.enabled=true \
  -Dspring.devtools.livereload.enabled=true' > start.sh

RUN chmod +x start.sh

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:4000/actuator/health || exit 1

CMD ["./start.sh"]